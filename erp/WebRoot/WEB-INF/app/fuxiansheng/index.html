
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="stylesheet" href="/css/main/index.css">
  <style media="screen">

  </style>
</head>
<body>


<dev>
  <img src="/img/fuxiansheng/main.png" style="width: 100%;">
</dev>

<script src="/js/jquery.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
<script src="/js/base.js"></script>
<script>
  $(function () {
      var code = getQueryString('code');
      var data ="";
      var openid = "";
      var expires_in = "";
      var refresh_token = "";
      var access_token = "";
      var scope = "";
      var timestamp= new Date().getTime().toString();
      var nonceStr = 'wxf557be9c5df580cb';
      getSignature(function(res){
          if(res){
              wx.config({
                  debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                  appId: res.appId, // 必填，公众号的唯一标识
                  timestamp: timestamp, // 必填，生成签名的时间戳
                  nonceStr: nonceStr, // 必填，生成签名的随机串
                  signature: res.signatureJs,// 必填，签名
                  jsApiList: ['getLocation'] // 必填，需要使用的JS接口列表
              });
          }


      });


      getTokenByCode(code,function (res) {

          getUserInfo(res.access_token,res.openid,function (data) {

          })
      });
      function getSignature(cb) {
          $.ajax({
              type: "get",
              url: "/wx/getJsApiSignature",
              dataType: 'json',
              data:{
                  noncestr:nonceStr,
                  timestamp:timestamp,
                  url:location.href
              },
              success: function (res) {
                  if(res.flag){
                      cb(res.object)
                  }else{
                      cb();
                  }
              }
          })
      }
      function getUserInfo(access_token,openid,cb) {
          $.ajax({
              type: "get",
              url: "/wx/getUserInfoByOpenid",
              dataType: 'json',
              data:{
                  access_token:access_token,
                  openid:openid,
                  lang:'zh_CN'
              },
              success: function (res) {
                if(res.flag){
                  var data = res.object;
                  alert(data.nickname);

                }else{

                alert("系统错误，请刷新重试!");
                }

              }
      })
      }
      function getTokenByCode(code,cb){

          $.ajax({
              type: "get",
              url: "/wx/getTokenByCode",
              dataType: 'json',
              data:{
                  code:code,
                  grantType:'snsapi_userinfo '
              },
              success: function (res) {
                  alert(JSON.stringify(res))
                  if(res.flag){
                       data = res.object;
                       openid = data.openid;
                       expires_in = data.expires_in;
                       refresh_token = data.refresh_token;
                       access_token = data.access_token;
                       scope = data.scope;
                      cb(data)

                  }else{
                      alert("系统错误，请刷新重试!")
                  }

              }
          });
      }
  });

  function getQueryString(name) {
      var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
      var r = window.location.search.substr(1).match(reg);
      if (r != null) {
          return unescape(r[2]);
      }
      return null;
  }
  wx.ready(function(){
      console.log(2)
      // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
  });
</script>
</body>
</html>
